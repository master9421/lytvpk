name: Release Build

# 触发条件：当你推送以 'v' 开头的 tag 时触发 (例如 v1.0.1)
on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Build and Release
    runs-on: windows-latest # 使用 Windows 环境构建
    permissions:
      contents: write # 需要写权限来创建 Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24" # 确保与你的开发环境一致

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Windows App
        shell: bash
        run: |
          # 1. 获取 Tag 名称 (例如 v1.0.1)
          TAG_NAME=${{ github.ref_name }}
          # 2. 去掉 'v' 前缀 (变成 1.0.1)，如果你希望保留 v，可以去掉这行处理
          VERSION=${TAG_NAME#v}

          echo "Building version: $VERSION"

          # 3. 运行 Wails 构建
          # -ldflags "-X main.AppVersion=$VERSION" 会将版本号注入到 main.go 的 AppVersion 变量中
          wails build -platform windows/amd64 -ldflags "-X main.AppVersion=$VERSION"

      - name: Compress Artifact
        run: |
          # 进入构建输出目录
          cd build/bin
          # 将 exe 压缩为 zip (go-github-selfupdate 要求 zip 格式)
          # 命名格式建议: 应用名_版本_系统_架构.zip
          Compress-Archive -Path lytvpk.exe -DestinationPath ../../lytvpk_${{ github.ref_name }}_windows_amd64.zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: lytvpk_${{ github.ref_name }}_windows_amd64.zip
          generate_release_notes: true # 自动根据 commit 生成更新日志
          draft: false
          prerelease: false
